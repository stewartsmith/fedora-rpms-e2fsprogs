--- e2fsprogs-1.39/debugfs/Makefile.in.dm	2005-09-06 05:40:13.000000000 -0400
+++ e2fsprogs-1.39/debugfs/Makefile.in	2006-07-06 14:11:32.000000000 -0400
@@ -27,7 +27,7 @@
 
 LIBS= $(LIBEXT2FS) $(LIBE2P) $(LIBSS) $(LIBCOM_ERR) $(LIBBLKID) \
 	$(LIBUUID) $(DLOPEN_LIB)
-DEPLIBS= $(LIBEXT2FS) $(LIBE2P) $(LIBSS) $(LIBCOM_ERR) $(LIBBLKID) $(DEPLIBUUID)
+DEPLIBS= $(LIBEXT2FS) $(LIBE2P) $(LIBSS) $(LIBCOM_ERR) $(DEPLIBBLKID) $(DEPLIBUUID)
 
 .c.o:
 	@echo "	CC $<"
--- e2fsprogs-1.39/MCONFIG.in.dm	2006-03-22 20:19:19.000000000 -0500
+++ e2fsprogs-1.39/MCONFIG.in	2006-07-06 14:11:32.000000000 -0400
@@ -79,6 +79,7 @@
 LIBBLKID = $(LIB)/libblkid@LIB_EXT@ $(DEVMAPPER_LIBS)
 LIBINTL = @LIBINTL@
 DEPLIBUUID = $(LIB)/libuuid@LIB_EXT@
+DEPLIBBLKID = $(LIB)/libblkid@LIB_EXT@
 
 STATIC_LIBSS = $(LIB)/libss@STATIC_LIB_EXT@
 STATIC_LIBCOM_ERR = $(LIB)/libcom_err@STATIC_LIB_EXT@
@@ -87,6 +88,7 @@
 STATIC_LIBUUID = $(LIB)/libuuid@STATIC_LIB_EXT@ @SOCKET_LIB@ 
 STATIC_LIBBLKID = $(LIB)/libblkid@STATIC_LIB_EXT@ $(STATIC_DEVMAPPER_LIBS)
 DEPSTATIC_LIBUUID = $(LIB)/libuuid@STATIC_LIB_EXT@
+DEPSTATIC_LIBBLKID = $(LIB)/libblkid@STATIC_LIB_EXT@
 
 PROFILED_LIBSS = $(LIB)/libss@PROFILED_LIB_EXT@
 PROFILED_LIBCOM_ERR = $(LIB)/libcom_err@PROFILED_LIB_EXT@
--- e2fsprogs-1.39/misc/Makefile.in.dm	2006-07-06 14:13:57.000000000 -0400
+++ e2fsprogs-1.39/misc/Makefile.in	2006-07-06 14:14:27.000000000 -0400
@@ -55,7 +55,7 @@
 STATIC_DEPLIBS= $(STATIC_LIBEXT2FS) $(STATIC_LIBCOM_ERR) 
 
 LIBS_BLKID= $(LIBBLKID) $(LIBUUID)
-DEPLIBS_BLKID= $(LIBBLKID) $(DEPLIBUUID)
+DEPLIBS_BLKID= $(DEPLIBBLKID) $(DEPLIBUUID)
 
 LIBS_E2P= $(LIBE2P) $(LIBCOM_ERR) 
 DEPLIBS_E2P= $(LIBE2P) $(LIBCOM_ERR) 
--- e2fsprogs-1.39/e2fsck/Makefile.in.dm	2006-03-27 00:44:11.000000000 -0500
+++ e2fsprogs-1.39/e2fsck/Makefile.in	2006-07-06 14:11:32.000000000 -0400
@@ -18,11 +18,11 @@
 XTRA_CFLAGS=	-DRESOURCE_TRACK -I.
 
 LIBS= $(LIBEXT2FS) $(LIBCOM_ERR) $(LIBBLKID) $(LIBUUID) $(LIBINTL)
-DEPLIBS= $(LIBEXT2FS) $(LIBCOM_ERR) $(LIBBLKID) $(DEPLIBUUID)
+DEPLIBS= $(LIBEXT2FS) $(LIBCOM_ERR) $(DEPLIBBLKID) $(DEPLIBUUID)
 
 STATIC_LIBS= $(STATIC_LIBEXT2FS) $(STATIC_LIBCOM_ERR) $(STATIC_LIBBLKID) \
 	$(STATIC_LIBUUID) $(LIBINTL)
-STATIC_DEPLIBS= $(STATIC_LIBEXT2FS) $(STATIC_LIBCOM_ERR) $(STATIC_LIBBLKID) \
+STATIC_DEPLIBS= $(STATIC_LIBEXT2FS) $(STATIC_LIBCOM_ERR) $(DEPSTATIC_LIBBLKID) \
 	$(DEPSTATIC_LIBUUID)
 
 PROFILED_LIBS= $(PROFILED_LIBEXT2FS) $(PROFILED_LIBCOM_ERR) \
@@ -119,7 +119,7 @@
 e2fsck.static: $(OBJS)  $(STATIC_DEPLIBS)
 	@echo "	LD $@"
 	@$(LD) $(ALL_LDFLAGS) $(LDFLAG_STATIC) -o e2fsck.static $(OBJS) \
-		$(STATIC_LIBS) 
+		$(STATIC_LIBS)
 
 e2fsck.shared: $(OBJS)  $(DEPLIBS)
 	@echo "	LD $@"
--- e2fsprogs-1.39/configure.in.dm	2006-04-08 21:36:21.000000000 -0400
+++ e2fsprogs-1.39/configure.in	2006-07-06 14:11:32.000000000 -0400
@@ -494,11 +494,15 @@
 	AC_DEFINE(HAVE_DEVMAPPER)
 	echo "Enabling device-mapper support"
 
-	DEVMAPPER_REQ='libselinux libsepol'
-	DEVMAPPER_PC_LIBS='-ldevmapper'
-	DEVMAPPER_LIBS='-ldevmapper -lselinux -lsepol'
-	STATIC_DEVMAPPER_LIBS='/usr/lib/libdevmapper.a /usr/lib/libselinux.a /usr/lib/libsepol.a'
-
+	PKG_PROG_PKG_CONFIG()
+ 
+	AC_CHECK_LIB(devmapper, dm_tree_create,
+		[DEVMAPPER_LIBS=`$PKG_CONFIG --libs devmapper`; 
+		 STATIC_DEVMAPPER_LIBS=`$PKG_CONFIG --static --libs devmapper`;
+		 DEVMAPPER_REQ="devmapper";
+		 DEVMAPPER_PC_LIBS="-ldevmapper"],
+		[AC_MSG_ERROR([device-mapper library not found])],
+		[$DEVMAPPER_LIBS])
 fi]
 ,
 echo "Disabling device-mapper support by default"
